# Pre-push hook: Run checks on blinky-console if it has changes
# Git passes refs via stdin: <local ref> <local sha1> <remote ref> <remote sha1>

ZERO_SHA="0000000000000000000000000000000000000000"

while read local_ref local_sha remote_ref remote_sha; do
  # Skip branch deletions
  if [ "$local_sha" = "$ZERO_SHA" ]; then
    continue
  fi

  # For new branches, compare against the merge-base with the default branch
  if [ "$remote_sha" = "$ZERO_SHA" ]; then
    # New branch - compare against origin/master
    base=$(git merge-base origin/master "$local_sha" 2>/dev/null || echo "origin/master")
    range="$base..$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi

  # Check if any blinky-console files changed in this push
  if git diff --name-only "$range" 2>/dev/null | grep -q "^blinky-console/"; then
    echo "ğŸ” blinky-console changes detected, running checks..."

    cd blinky-console

    echo "ğŸ“ Running lint..."
    npm run lint || exit 1

    echo "ğŸ” Running type check..."
    npm run typecheck || exit 1

    echo "ğŸ”¨ Running build..."
    npm run build || exit 1

    echo "âœ… All blinky-console checks passed!"
    exit 0
  fi
done

exit 0
