#!/bin/bash
#
# Pre-push hook: runs cppcheck before allowing push
# Install with: ./scripts/install-hooks.sh
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Find the repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Check if cppcheck is installed
if ! command -v cppcheck &> /dev/null; then
    echo -e "${YELLOW}⚠️  cppcheck not installed, skipping static analysis${NC}"
    echo "   Install with: sudo apt install cppcheck (Linux)"
    echo "                 brew install cppcheck (macOS)"
    echo "                 choco install cppcheck (Windows)"
    exit 0
fi

echo "Running cppcheck static analysis..."

# Run cppcheck with same settings as CI
CPPCHECK_ARGS=(
    --enable=warning,style,performance,portability
    --error-exitcode=1
    --inline-suppr
    -I blinky-things/
    --std=c++14
    --platform=native
    --quiet
)

# Add suppressions file if it exists
if [ -f ".cppcheck-suppressions" ]; then
    CPPCHECK_ARGS+=(--suppressions-list=.cppcheck-suppressions)
fi

# Run cppcheck
if cppcheck "${CPPCHECK_ARGS[@]}" blinky-things/ 2>&1; then
    echo -e "${GREEN}✅ cppcheck passed${NC}"
else
    echo -e "${RED}❌ cppcheck found issues${NC}"
    echo ""
    echo "Fix the issues above before pushing, or use:"
    echo "  git push --no-verify  (to skip this check)"
    exit 1
fi

echo -e "${GREEN}✅ All pre-push checks passed${NC}"
exit 0
