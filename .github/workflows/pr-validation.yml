name: PR Validation

on:
  pull_request:
    branches: [ master ]

jobs:
  compilation-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        device-type: [1, 2, 3]  # Hat, Tube Light, Bucket Totem
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v2
      with:
        version: "1.0.4"
        
    - name: Add Seeeduino board index
      run: |
        arduino-cli config add board_manager.additional_urls https://files.seeedstudio.com/arduino/package_seeeduino_boards_index.json
        
    - name: Install Arduino cores and libraries
      run: |
        arduino-cli core update-index
        arduino-cli core install Seeeduino:nrf52
        arduino-cli lib install "Adafruit NeoPixel"
        
    - name: Set device type
      run: |
        sed -i 's/#define DEVICE_TYPE [0-9]/#define DEVICE_TYPE ${{ matrix.device-type }}/' blinky-things/blinky-things.ino
        
    - name: Compile sketch
      run: |
        arduino-cli compile --fqbn Seeeduino:nrf52:xiaonRF52840Sense blinky-things/

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check code formatting
      run: |
        echo "Checking for common code issues..."
        
        # Check for trailing whitespace
        if find blinky-things/ -name "*.cpp" -o -name "*.h" -o -name "*.ino" | xargs grep -l "[ \t]$"; then
          echo "âŒ Found trailing whitespace in files above"
          exit 1
        fi
        echo "âœ… No trailing whitespace found"
        
        # Check for consistent include guards
        echo "Checking include guards..."
        find blinky-things/ -name "*.h" -exec grep -L "#pragma once\|#ifndef.*_H" {} \; | while read file; do
          if [ -n "$file" ]; then
            echo "âŒ Missing include guard in $file"
            exit 1
          fi
        done
        echo "âœ… Include guards OK"

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check documentation
      run: |
        echo "Checking documentation completeness..."
        
        required_files=("README.md" "LICENSE" "CONTRIBUTING.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done
        echo "âœ… All required documentation files present"

  pr-summary:
    runs-on: ubuntu-latest
    needs: [compilation-tests, code-quality, documentation]
    if: always()
    
    steps:
    - name: PR Status Summary
      run: |
        echo "## ðŸ¤– PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.compilation-tests.result }}" == "success" ]; then
          echo "âœ… **Compilation Tests**: All device configurations compile successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Compilation Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "âœ… **Code Quality**: All checks passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Code Quality**: Issues found" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.documentation.result }}" == "success" ]; then
          echo "âœ… **Documentation**: Complete" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Documentation**: Missing files" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for review! ðŸš€" >> $GITHUB_STEP_SUMMARY